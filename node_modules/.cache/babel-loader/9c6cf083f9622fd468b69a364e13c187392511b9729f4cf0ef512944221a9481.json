{"ast":null,"code":"/*!\n* rete-scopes-plugin v2.0.1\n* (c) 2024 Vitaliy Stoliarov\n* Released under the CC-BY-NC-SA-4.0 license.\n* */\nimport _toConsumableArray from '@babel/runtime/helpers/toConsumableArray';\nimport _asyncToGenerator from '@babel/runtime/helpers/asyncToGenerator';\nimport _classCallCheck from '@babel/runtime/helpers/classCallCheck';\nimport _createClass from '@babel/runtime/helpers/createClass';\nimport _assertThisInitialized from '@babel/runtime/helpers/assertThisInitialized';\nimport _get from '@babel/runtime/helpers/get';\nimport _inherits from '@babel/runtime/helpers/inherits';\nimport _possibleConstructorReturn from '@babel/runtime/helpers/possibleConstructorReturn';\nimport _getPrototypeOf from '@babel/runtime/helpers/getPrototypeOf';\nimport _defineProperty from '@babel/runtime/helpers/defineProperty';\nimport _regeneratorRuntime from '@babel/runtime/regenerator';\nimport { NodeEditor, Scope } from 'rete';\nimport { BaseAreaPlugin } from 'rete-area-plugin';\nimport _typeof from '@babel/runtime/helpers/typeof';\nfunction bringConnectionForward(id, props) {\n  var view = props.area.connectionViews.get(id);\n  if (view) {\n    props.area.area.content.reorder(view.element, null);\n  }\n}\nfunction bringConnectionBack(id, props) {\n  var view = props.area.connectionViews.get(id);\n  var content = props.area.area.content;\n  if (view) {\n    content.reorder(view.element, content.holder.firstChild);\n  }\n}\nfunction bringForward(nodeId, props) {\n  var view = props.area.nodeViews.get(nodeId);\n  var connections = props.editor.getConnections().filter(function (c) {\n    return nodeId === c.source || nodeId === c.target;\n  });\n  var children = props.editor.getNodes().filter(function (n) {\n    return n.parent === nodeId;\n  });\n  connections.forEach(function (connection) {\n    return bringConnectionForward(connection.id, props);\n  });\n  if (view) {\n    props.area.area.content.reorder(view.element, null);\n  }\n  children.forEach(function (child) {\n    return bringForward(child.id, props);\n  });\n}\nfunction useOrdering(props) {\n  // eslint-disable-next-line max-statements\n  props.area.addPipe( /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(context) {\n      var id, connection;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            if ('type' in context) {\n              _context.next = 2;\n              break;\n            }\n            return _context.abrupt(\"return\", context);\n          case 2:\n            if (context.type === 'nodepicked') {\n              bringForward(context.data.id, props);\n            }\n            if (!(context.type === 'connectioncreated')) {\n              _context.next = 11;\n              break;\n            }\n            id = context.data.id;\n            connection = props.editor.getConnection(id);\n            if (connection) {\n              _context.next = 8;\n              break;\n            }\n            throw new Error('connection was removed');\n          case 8:\n            bringConnectionBack(context.data.id, props);\n            bringForward(connection.source, props);\n            bringForward(connection.target, props);\n          case 11:\n            return _context.abrupt(\"return\", context);\n          case 12:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee);\n    }));\n    return function (_x) {\n      return _ref.apply(this, arguments);\n    };\n  }());\n}\nfunction getNodesBoundingBox(nodes, _ref) {\n  var area = _ref.area;\n  var boxes = nodes.map(function (node) {\n    var view = area.nodeViews.get(node.id);\n    if (!view) throw new Error('view');\n    return {\n      position: view.position,\n      width: node.width,\n      height: node.height\n    };\n  });\n  var left = Math.min.apply(Math, _toConsumableArray(boxes.map(function (b) {\n    return b.position.x;\n  })));\n  var right = Math.max.apply(Math, _toConsumableArray(boxes.map(function (b) {\n    return b.position.x + b.width;\n  })));\n  var top = Math.min.apply(Math, _toConsumableArray(boxes.map(function (b) {\n    return b.position.y;\n  })));\n  var bottom = Math.max.apply(Math, _toConsumableArray(boxes.map(function (b) {\n    return b.position.y + b.height;\n  })));\n  var width = right - left;\n  var height = bottom - top;\n  return {\n    top: top,\n    left: left,\n    right: right,\n    bottom: bottom,\n    width: width,\n    height: height\n  };\n}\nfunction updateNodeSizes(node, size, _ref2) {\n  var area = _ref2.area;\n  var width = size.width,\n    height = size.height;\n  node.width = width;\n  node.height = height;\n  area.resize(node.id, width, height);\n}\n\n// eslint-disable-next-line max-statements\nfunction resizeParent(_x, _x2, _x3) {\n  return _resizeParent.apply(this, arguments);\n}\nfunction _resizeParent() {\n  _resizeParent = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(parent, agentParams, props) {\n    var id, children, padding, size, _getNodesBoundingBox, top, left, width, height, outerWidth, outerHeight, outerTop, outerLeft, parentsParent;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) switch (_context.prev = _context.next) {\n        case 0:\n          id = parent.id;\n          children = props.editor.getNodes().filter(function (child) {\n            return child.parent === id;\n          }).filter(function (node) {\n            return !agentParams.exclude(node.id);\n          });\n          padding = agentParams.padding(id);\n          if (!(children.length === 0)) {\n            _context.next = 8;\n            break;\n          }\n          size = agentParams.size(id, {\n            width: padding.left + padding.right,\n            height: padding.top + padding.bottom\n          });\n          updateNodeSizes(parent, size, props);\n          _context.next = 16;\n          break;\n        case 8:\n          _getNodesBoundingBox = getNodesBoundingBox(children, props), top = _getNodesBoundingBox.top, left = _getNodesBoundingBox.left, width = _getNodesBoundingBox.width, height = _getNodesBoundingBox.height;\n          outerWidth = width + padding.left + padding.right;\n          outerHeight = height + padding.top + padding.bottom;\n          outerTop = top - padding.top;\n          outerLeft = left - padding.left;\n          updateNodeSizes(parent, agentParams.size(id, {\n            width: outerWidth,\n            height: outerHeight\n          }), props);\n          _context.next = 16;\n          return agentParams.translate(parent.id, outerLeft, outerTop);\n        case 16:\n          if (!parent.parent) {\n            _context.next = 21;\n            break;\n          }\n          parentsParent = props.editor.getNode(parent.parent);\n          if (!parentsParent) {\n            _context.next = 21;\n            break;\n          }\n          _context.next = 21;\n          return resizeParent(parentsParent, agentParams, props);\n        case 21:\n        case \"end\":\n          return _context.stop();\n      }\n    }, _callee);\n  }));\n  return _resizeParent.apply(this, arguments);\n}\nfunction _createForOfIteratorHelper(o, allowArrayLike) {\n  var it = typeof Symbol !== \"undefined\" && o[Symbol.iterator] || o[\"@@iterator\"];\n  if (!it) {\n    if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") {\n      if (it) o = it;\n      var i = 0;\n      var F = function F() {};\n      return {\n        s: F,\n        n: function n() {\n          if (i >= o.length) return {\n            done: true\n          };\n          return {\n            done: false,\n            value: o[i++]\n          };\n        },\n        e: function e(_e) {\n          throw _e;\n        },\n        f: F\n      };\n    }\n    throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n  }\n  var normalCompletion = true,\n    didErr = false,\n    err;\n  return {\n    s: function s() {\n      it = it.call(o);\n    },\n    n: function n() {\n      var step = it.next();\n      normalCompletion = step.done;\n      return step;\n    },\n    e: function e(_e2) {\n      didErr = true;\n      err = _e2;\n    },\n    f: function f() {\n      try {\n        if (!normalCompletion && it[\"return\"] != null) it[\"return\"]();\n      } finally {\n        if (didErr) throw err;\n      }\n    }\n  };\n}\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return _arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);\n}\nfunction _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n  for (var i = 0, arr2 = new Array(len); i < len; i++) arr2[i] = arr[i];\n  return arr2;\n}\n// eslint-disable-next-line max-statements, max-len\nfunction reassignParent(_x, _x2, _x3, _x4) {\n  return _reassignParent.apply(this, arguments);\n}\nfunction _reassignParent() {\n  _reassignParent = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(ids, pointer, agentParams, props) {\n    var nodes, overlayNodes, areaElements, overlayNodesWithIndex, topOverlayParent, formerParents, _iterator, _step, formerParent;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) switch (_context.prev = _context.next) {\n        case 0:\n          if (ids.length) {\n            _context.next = 2;\n            break;\n          }\n          return _context.abrupt(\"return\");\n        case 2:\n          nodes = ids.map(function (id) {\n            return props.editor.getNode(id);\n          }).filter(function (n) {\n            return Boolean(n);\n          });\n          overlayNodes = props.editor.getNodes().map(function (node) {\n            var view = props.area.nodeViews.get(node.id);\n            if (!view) throw new Error('node view');\n            return {\n              node: node,\n              view: view\n            };\n          }).filter(function (_ref2) {\n            var node = _ref2.node,\n              view = _ref2.view;\n            return !ids.includes(node.id) && pointer.x > view.position.x && pointer.y > view.position.y && pointer.x < view.position.x + node.width && pointer.y < view.position.y + node.height;\n          });\n          areaElements = Array.from(props.area.area.content.holder.childNodes);\n          overlayNodesWithIndex = overlayNodes.map(function (_ref3) {\n            var node = _ref3.node,\n              view = _ref3.view;\n            var index = areaElements.indexOf(view.element);\n            return {\n              node: node,\n              view: view,\n              index: index\n            };\n          });\n          overlayNodesWithIndex.sort(function (a, b) {\n            return b.index - a.index;\n          });\n          topOverlayParent = overlayNodesWithIndex[0];\n          formerParents = nodes.map(function (node) {\n            return node.parent;\n          }).filter(function (id) {\n            return Boolean(id);\n          }).map(function (id) {\n            var node = props.editor.getNode(id);\n            if (!node) throw new Error('node');\n            return node;\n          }); // eslint-disable-next-line no-undefined\n          nodes.forEach(function (node) {\n            return node.parent = undefined;\n          });\n          if (!topOverlayParent) {\n            _context.next = 14;\n            break;\n          }\n          nodes.forEach(function (node) {\n            return node.parent = topOverlayParent.node.id;\n          });\n          _context.next = 14;\n          return resizeParent(topOverlayParent.node, agentParams, props);\n        case 14:\n          _iterator = _createForOfIteratorHelper(formerParents);\n          _context.prev = 15;\n          _iterator.s();\n        case 17:\n          if ((_step = _iterator.n()).done) {\n            _context.next = 23;\n            break;\n          }\n          formerParent = _step.value;\n          _context.next = 21;\n          return resizeParent(formerParent, agentParams, props);\n        case 21:\n          _context.next = 17;\n          break;\n        case 23:\n          _context.next = 28;\n          break;\n        case 25:\n          _context.prev = 25;\n          _context.t0 = _context[\"catch\"](15);\n          _iterator.e(_context.t0);\n        case 28:\n          _context.prev = 28;\n          _iterator.f();\n          return _context.finish(28);\n        case 31:\n        case \"end\":\n          return _context.stop();\n      }\n    }, _callee, null, [[15, 25, 28, 31]]);\n  }));\n  return _reassignParent.apply(this, arguments);\n}\nfunction translateChildren(_x5, _x6, _x7) {\n  return _translateChildren.apply(this, arguments);\n}\nfunction _translateChildren() {\n  _translateChildren = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(id, _ref, props) {\n    var position, previous, children;\n    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) switch (_context3.prev = _context3.next) {\n        case 0:\n          position = _ref.position, previous = _ref.previous;\n          children = props.editor.getNodes().filter(function (n) {\n            return n.parent === id;\n          });\n          _context3.next = 4;\n          return Promise.all(children.map( /*#__PURE__*/function () {\n            var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(n) {\n              var dx, dy, view, node, nodePosition;\n              return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n                while (1) switch (_context2.prev = _context2.next) {\n                  case 0:\n                    dx = position.x - previous.x;\n                    dy = position.y - previous.y;\n                    view = props.area.nodeViews.get(n.id);\n                    node = props.editor.getNode(n.id);\n                    if (!(view && node && !node.selected)) {\n                      _context2.next = 8;\n                      break;\n                    }\n                    nodePosition = view.position;\n                    _context2.next = 8;\n                    return view.translate(nodePosition.x + dx, nodePosition.y + dy);\n                  case 8:\n                  case \"end\":\n                    return _context2.stop();\n                }\n              }, _callee2);\n            }));\n            return function (_x8) {\n              return _ref4.apply(this, arguments);\n            };\n          }()));\n        case 4:\n        case \"end\":\n          return _context3.stop();\n      }\n    }, _callee3);\n  }));\n  return _translateChildren.apply(this, arguments);\n}\nfunction belongsTo(nodeId, ids, props) {\n  var node = props.editor.getNode(nodeId);\n  if (!node) throw new Error('node');\n  if (ids.includes(nodeId)) return true;\n  if (!node.parent) return false;\n  if (belongsTo(node.parent, ids, props)) return true;\n}\nfunction hasSelectedParent(nodeId, props) {\n  var node = props.editor.getNode(nodeId);\n  if (!node) throw new Error('node');\n  if (!node.parent) return false;\n  var parent = props.editor.getNode(node.parent);\n  if (!parent) throw new Error('node');\n  if (parent.selected) return true;\n  return hasSelectedParent(node.parent, props);\n}\n/**\n * keep track of currently moving nodes (to prevent infinite loop)\n */\nfunction trackedTranslate(props) {\n  var active = new Map();\n  var increment = function increment(id) {\n    return active.set(id, (active.get(id) || 0) + 1);\n  };\n  var decrement = function decrement(id) {\n    return active.set(id, (active.get(id) || 0) - 1);\n  };\n  return {\n    translate: function translate(id, x, y) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var view, previous;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              view = props.area.nodeViews.get(id);\n              if (view) {\n                _context.next = 3;\n                break;\n              }\n              throw new Error('cannot find parent node view');\n            case 3:\n              previous = view.position;\n              if (!(previous.x !== x || previous.y !== y)) {\n                _context.next = 9;\n                break;\n              }\n              increment(id);\n              _context.next = 8;\n              return view.translate(x, y);\n            case 8:\n              decrement(id);\n            case 9:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee);\n      }))();\n    },\n    isTranslating: function isTranslating(id) {\n      return (active.get(id) || 0) > 0;\n    }\n  };\n}\nfunction watchClearing(editor) {\n  var state = false;\n  editor.addPipe(function (context) {\n    if (context.type === 'clear') {\n      state = true;\n    }\n    if (context.type === 'cleared' || context.type === 'clearcancelled') {\n      state = false;\n    }\n    return context;\n  });\n  return function () {\n    return state;\n  };\n}\nfunction useValidator(props) {\n  var isClearing = watchClearing(props.editor);\n\n  // eslint-disable-next-line max-statements\n  props.area.addPipe(function (context) {\n    if (!context || !(_typeof(context) === 'object' && 'type' in context)) return context;\n    if (context.type === 'nodecreate') {\n      var parentId = context.data.parent;\n      if (parentId) {\n        var parent = props.editor.getNodes().find(function (n) {\n          return n.id === parentId;\n        });\n        if (!parent) throw new Error('parent node doesnt exist');\n      }\n    }\n    if (context.type === 'noderemove' && !isClearing()) {\n      var id = context.data.id;\n      var child = props.editor.getNodes().find(function (n) {\n        return n.parent === id;\n      });\n      if (child) throw new Error('cannot remove parent node with a children');\n    }\n    return context;\n  });\n}\nvar useScopeAgent = function useScopeAgent(params, _ref) {\n  var area = _ref.area,\n    editor = _ref.editor,\n    scopes = _ref.scopes;\n  var timeout = params.timeout || 250;\n  var picked = null;\n  var candidates = [];\n  function cancel() {\n    if (picked) {\n      window.clearTimeout(picked.timeout);\n      picked = null;\n    }\n  }\n  function pick(id) {\n    var timeoutId = window.setTimeout(function () {\n      var _candidates;\n      var selected = editor.getNodes().filter(function (n) {\n        return n.selected;\n      });\n      var targets = selected.length ? selected.map(function (n) {\n        return n.id;\n      }) : [id];\n      (_candidates = candidates).push.apply(_candidates, _toConsumableArray(targets));\n      scopes.emit({\n        type: 'scopepicked',\n        data: {\n          ids: targets\n        }\n      });\n    }, timeout);\n    picked = {\n      timeout: timeoutId\n    };\n  }\n  function release() {\n    var list = _toConsumableArray(candidates);\n    cancel();\n    candidates = [];\n    scopes.emit({\n      type: 'scopereleased',\n      data: {\n        ids: list\n      }\n    });\n    return list;\n  }\n  area.addPipe( /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(context) {\n      var pointer, ids;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            if ('type' in context) {\n              _context.next = 2;\n              break;\n            }\n            return _context.abrupt(\"return\", context);\n          case 2:\n            if (context.type === 'nodepicked') {\n              pick(context.data.id);\n            }\n            if (context.type === 'nodetranslated') {\n              cancel();\n            }\n            if (!(context.type === 'nodedragged')) {\n              _context.next = 9;\n              break;\n            }\n            pointer = area.area.pointer;\n            ids = release();\n            _context.next = 9;\n            return reassignParent(ids, pointer, params, {\n              area: area,\n              editor: editor\n            });\n          case 9:\n            return _context.abrupt(\"return\", context);\n          case 10:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee);\n    }));\n    return function (_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }());\n};\nfunction useVisualEffects(_ref3) {\n  var area = _ref3.area,\n    editor = _ref3.editor,\n    scopes = _ref3.scopes;\n  var pickedNodes = getPickedNodes(scopes);\n  var previousHighlighted = null;\n  var clientPointerPostion = null;\n\n  // eslint-disable-next-line max-statements\n  function updateHighlightedScopes(position, nodes) {\n    if (previousHighlighted) {\n      var view = area.nodeViews.get(previousHighlighted);\n      if (view && nodes.length) view.element.style.opacity = '0.4';\n      previousHighlighted = null;\n    }\n    if (nodes.length) {\n      var x = position.x,\n        y = position.y;\n      var elements = document.elementsFromPoint(x, y);\n      var nodeViews = editor.getNodes().map(function (node) {\n        var view = area.nodeViews.get(node.id);\n        if (!view) throw new Error('view');\n        return {\n          node: node,\n          view: view\n        };\n      });\n      var intersectedNodes = elements.map(function (el) {\n        return nodeViews.find(function (item) {\n          return item.view.element === el;\n        });\n      }).filter(function (item) {\n        return Boolean(item);\n      });\n      var nonSelected = intersectedNodes.filter(function (item) {\n        return !item.node.selected;\n      });\n      var first = nonSelected[0];\n      if (first) {\n        first.view.element.style.opacity = '0.8';\n        previousHighlighted = first.node.id;\n      }\n    }\n  }\n  // eslint-disable-next-line max-statements\n  scopes.addPipe(function (context) {\n    if (context.type === 'scopepicked') {\n      var ids = context.data.ids;\n      editor.getNodes().filter(function (n) {\n        return !ids.includes(n.id);\n      }).forEach(function (node) {\n        var view = area.nodeViews.get(node.id);\n        if (view) view.element.style.opacity = '0.4';\n      });\n      if (clientPointerPostion) updateHighlightedScopes(clientPointerPostion, pickedNodes);\n    }\n    if (context.type === 'scopereleased') {\n      var _ids = context.data.ids;\n      editor.getNodes().filter(function (n) {\n        return !_ids.includes(n.id);\n      }).forEach(function (node) {\n        var view = area.nodeViews.get(node.id);\n        if (view) view.element.style.opacity = '';\n      });\n      if (clientPointerPostion) updateHighlightedScopes(clientPointerPostion, pickedNodes);\n    }\n    if (context.type === 'pointermove') {\n      clientPointerPostion = {\n        x: context.data.event.clientX,\n        y: context.data.event.clientY\n      };\n      updateHighlightedScopes(clientPointerPostion, pickedNodes);\n    }\n    return context;\n  });\n}\n\n/**\n * Classic preset allowing capturing a node by long-pressing it and dropping it onto another node to make it a nested.\n * @returns Preset\n * @listens nodepicked\n * @listens nodetranslated\n * @listens nodedragged\n * @emits scopepicked\n * @emits scopereleased\n */\nfunction setup() {\n  return function (params, context) {\n    useScopeAgent(params, context);\n    useVisualEffects(context);\n  };\n}\nvar index$1 = /*#__PURE__*/Object.freeze({\n  __proto__: null,\n  setup: setup\n});\n\n/**\n * Presets for scopes plugin.\n * @module\n */\n\nvar index = /*#__PURE__*/Object.freeze({\n  __proto__: null,\n  classic: index$1\n});\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    enumerableOnly && (symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    })), keys.push.apply(keys, symbols);\n  }\n  return keys;\n}\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = null != arguments[i] ? arguments[i] : {};\n    i % 2 ? ownKeys(Object(source), !0).forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) {\n      Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n    });\n  }\n  return target;\n}\nfunction _createSuper(Derived) {\n  var hasNativeReflectConstruct = _isNativeReflectConstruct();\n  return function _createSuperInternal() {\n    var Super = _getPrototypeOf(Derived),\n      result;\n    if (hasNativeReflectConstruct) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n    return _possibleConstructorReturn(this, result);\n  };\n}\nfunction _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n  try {\n    Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n/**\n * Props for `ScopesPlugin` class.\n */\n/**\n * Signal types produced by ConnectionPlugin instance\n * @priority 10\n */\n/**\n * Scope plugin. Responsible for user interaction with scopes (nested nodes, groups)\n * @priority 9\n * @listens nodetranslated\n * @listens noderemoved\n * @emits scopepicked\n * @emits scopereleased\n */\nvar ScopesPlugin = /*#__PURE__*/function (_Scope) {\n  _inherits(ScopesPlugin, _Scope);\n  var _super = _createSuper(ScopesPlugin);\n  function ScopesPlugin(props) {\n    var _this;\n    _classCallCheck(this, ScopesPlugin);\n    _this = _super.call(this, 'scopes');\n    _defineProperty(_assertThisInitialized(_this), \"presets\", []);\n    _this.padding = (props === null || props === void 0 ? void 0 : props.padding) || function () {\n      return {\n        top: 40,\n        left: 20,\n        right: 20,\n        bottom: 20\n      };\n    };\n    _this.exclude = (props === null || props === void 0 ? void 0 : props.exclude) || function () {\n      return false;\n    };\n    _this.size = (props === null || props === void 0 ? void 0 : props.size) || function (id, size) {\n      return size;\n    };\n    return _this;\n  }\n\n  // eslint-disable-next-line max-statements\n  _createClass(ScopesPlugin, [{\n    key: \"setParent\",\n    value: function setParent(scope) {\n      var _this2 = this;\n      _get(_getPrototypeOf(ScopesPlugin.prototype), \"setParent\", this).call(this, scope);\n      this.area = this.parentScope(BaseAreaPlugin);\n      this.editor = this.area.parentScope(NodeEditor);\n      var props = {\n        editor: this.editor,\n        area: this.area\n      };\n      var padding = this.padding,\n        size = this.size,\n        exclude = this.exclude;\n      var pickedNodes = getPickedNodes(this);\n      var _trackedTranslate = trackedTranslate(props),\n        translate = _trackedTranslate.translate,\n        isTranslating = _trackedTranslate.isTranslating;\n      var agentParams = {\n        padding: padding,\n        size: size,\n        exclude: exclude,\n        translate: translate\n      };\n      useValidator(props);\n      useOrdering(props);\n      this.presets.forEach(function (preset) {\n        preset(agentParams, _objectSpread(_objectSpread({}, props), {}, {\n          scopes: _this2\n        }));\n      });\n\n      // eslint-disable-next-line max-statements, complexity\n      this.addPipe( /*#__PURE__*/function () {\n        var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(context) {\n          var _id, current, parent, hasAnySelectedParent, isPicked, parentId, _parent, _parent2;\n          return _regeneratorRuntime.wrap(function _callee$(_context) {\n            while (1) switch (_context.prev = _context.next) {\n              case 0:\n                if (!(context.type === 'nodetranslated')) {\n                  _context.next = 15;\n                  break;\n                }\n                _id = context.data.id;\n                current = props.editor.getNode(_id);\n                if (current) {\n                  _context.next = 5;\n                  break;\n                }\n                throw new Error('cannot find node');\n              case 5:\n                if (isTranslating(_id)) {\n                  _context.next = 8;\n                  break;\n                }\n                _context.next = 8;\n                return translateChildren(_id, context.data, props);\n              case 8:\n                parent = current.parent ? props.editor.getNode(current.parent) : null;\n                if (!(parent && !agentParams.exclude(_id))) {\n                  _context.next = 15;\n                  break;\n                }\n                hasAnySelectedParent = hasSelectedParent(_id, props);\n                isPicked = belongsTo(current.id, pickedNodes, props);\n                if (!(!hasAnySelectedParent && !isPicked)) {\n                  _context.next = 15;\n                  break;\n                }\n                _context.next = 15;\n                return resizeParent(parent, agentParams, props);\n              case 15:\n                if (!(context.type === 'noderemoved')) {\n                  _context.next = 21;\n                  break;\n                }\n                parentId = context.data.parent;\n                _parent = parentId && props.editor.getNode(parentId);\n                if (!_parent) {\n                  _context.next = 21;\n                  break;\n                }\n                _context.next = 21;\n                return resizeParent(_parent, agentParams, props);\n              case 21:\n                if (!(context.type === 'scopeupdated')) {\n                  _context.next = 26;\n                  break;\n                }\n                _parent2 = _this2.editor.getNode(context.data.id);\n                if (!_parent2) {\n                  _context.next = 26;\n                  break;\n                }\n                _context.next = 26;\n                return resizeParent(_parent2, agentParams, props);\n              case 26:\n                return _context.abrupt(\"return\", context);\n              case 27:\n              case \"end\":\n                return _context.stop();\n            }\n          }, _callee);\n        }));\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    }\n\n    /**\n     * Adds a preset to the plugin.\n     * @param preset Preset that is responsible for user interactions with scopes (e.g. assigning nodes to scopes)\n     */\n  }, {\n    key: \"addPreset\",\n    value: function addPreset(preset) {\n      this.presets.push(preset);\n    }\n  }, {\n    key: \"isDependent\",\n    value: function isDependent(id) {\n      var props = {\n        editor: this.editor,\n        area: this.area\n      };\n      var node = this.editor.getNode(id);\n      return node && (node.selected || hasSelectedParent(id, props));\n    }\n  }, {\n    key: \"update\",\n    value: function () {\n      var _update = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(scopeId) {\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return this.emit({\n                type: 'scopeupdated',\n                data: {\n                  id: scopeId\n                }\n              });\n            case 2:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2, this);\n      }));\n      function update(_x2) {\n        return _update.apply(this, arguments);\n      }\n      return update;\n    }()\n  }]);\n  return ScopesPlugin;\n}(Scope);\nfunction getPickedNodes(scopes) {\n  var nodes = [];\n  scopes.addPipe( /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(context) {\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) switch (_context3.prev = _context3.next) {\n          case 0:\n            if ('type' in context) {\n              _context3.next = 2;\n              break;\n            }\n            return _context3.abrupt(\"return\", context);\n          case 2:\n            if (context.type === 'scopepicked') {\n              nodes.push.apply(nodes, _toConsumableArray(context.data.ids));\n            }\n            if (context.type === 'scopereleased') {\n              nodes.splice.apply(nodes, [0, nodes.length].concat(_toConsumableArray(nodes.filter(function (id) {\n                return !context.data.ids.includes(id);\n              }))));\n            }\n            return _context3.abrupt(\"return\", context);\n          case 5:\n          case \"end\":\n            return _context3.stop();\n        }\n      }, _callee3);\n    }));\n    return function (_x3) {\n      return _ref2.apply(this, arguments);\n    };\n  }());\n  return nodes;\n}\nexport { index as Presets, ScopesPlugin, getPickedNodes };","map":{"version":3,"names":["bringConnectionForward","id","props","view","area","connectionViews","get","content","reorder","element","bringConnectionBack","holder","firstChild","bringForward","nodeId","nodeViews","connections","editor","getConnections","filter","c","source","target","children","getNodes","n","parent","forEach","connection","child","useOrdering","addPipe","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","context","wrap","_callee$","_context","prev","next","abrupt","type","data","getConnection","Error","stop","_x","apply","arguments","getNodesBoundingBox","nodes","boxes","map","node","position","width","height","left","Math","min","_toConsumableArray","b","x","right","max","top","y","bottom","updateNodeSizes","size","_ref2","resize","resizeParent","_x2","_x3","_resizeParent","agentParams","padding","_getNodesBoundingBox","outerWidth","outerHeight","outerTop","outerLeft","parentsParent","exclude","length","translate","getNode","reassignParent","_x4","_reassignParent","ids","pointer","overlayNodes","areaElements","overlayNodesWithIndex","topOverlayParent","formerParents","_iterator","_step","formerParent","Boolean","includes","Array","from","childNodes","_ref3","index","indexOf","sort","a","undefined","_createForOfIteratorHelper","s","done","value","t0","e","f","finish","translateChildren","_x5","_x6","_x7","_translateChildren","_callee3","previous","_callee3$","_context3","Promise","all","_ref4","_callee2","dx","dy","nodePosition","_callee2$","_context2","selected","_x8","belongsTo","hasSelectedParent","trackedTranslate","active","Map","increment","set","decrement","isTranslating","watchClearing","state","useValidator","isClearing","_typeof","parentId","find","useScopeAgent","params","scopes","timeout","picked","candidates","cancel","window","clearTimeout","pick","timeoutId","setTimeout","_candidates","targets","push","emit","release","list","useVisualEffects","pickedNodes","getPickedNodes","previousHighlighted","clientPointerPostion","updateHighlightedScopes","style","opacity","elements","document","elementsFromPoint","intersectedNodes","el","item","nonSelected","first","_ids","event","clientX","clientY","setup","ScopesPlugin","_Scope","_inherits","_super","_createSuper","_this","_classCallCheck","call","_defineProperty","_assertThisInitialized","_createClass","key","setParent","scope","_this2","_get","_getPrototypeOf","prototype","parentScope","BaseAreaPlugin","NodeEditor","_trackedTranslate","presets","preset","_objectSpread","_id","current","hasAnySelectedParent","isPicked","_parent","_parent2","addPreset","isDependent","_update","scopeId","update","Scope","splice","concat"],"sources":["/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/ordering.ts","/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/sizing.ts","/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/scope.ts","/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/utils.ts","/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/validation.ts","/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/agents/classic/index.ts","/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/presets/classic/index.ts","/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/presets/index.ts","/Users/jolu/Documents/code/jira-node-editor/node_modules/rete-scopes-plugin/src/index.ts"],"sourcesContent":["import { ConnectionId, NodeEditor, NodeId } from 'rete'\nimport { BaseArea, BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { ExpectedScheme } from './types'\n\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, BaseArea<ExpectedScheme> | T> }\n\nfunction bringConnectionForward<T>(id: ConnectionId, props: Props<T>) {\n  const view = props.area.connectionViews.get(id)\n\n  if (view) {\n    props.area.area.content.reorder(view.element, null)\n  }\n}\n\nfunction bringConnectionBack<T>(id: ConnectionId, props: Props<T>) {\n  const view = props.area.connectionViews.get(id)\n  const { content } = props.area.area\n\n  if (view) {\n    content.reorder(view.element, content.holder.firstChild)\n  }\n}\n\nfunction bringForward<T>(nodeId: NodeId, props: Props<T>) {\n  const view = props.area.nodeViews.get(nodeId)\n  const connections = props.editor.getConnections().filter(c => {\n    return nodeId === c.source || nodeId === c.target\n  })\n  const children = props.editor.getNodes().filter(n => {\n    return n.parent === nodeId\n  })\n\n  connections.forEach(connection => bringConnectionForward(connection.id, props))\n\n  if (view) {\n    props.area.area.content.reorder(view.element, null)\n  }\n\n  children.forEach(child => bringForward(child.id, props))\n}\n\nexport function useOrdering<T>(props: Props<T>) {\n  // eslint-disable-next-line max-statements\n  props.area.addPipe(async context => {\n    if (!('type' in context)) return context\n    if (context.type === 'nodepicked') {\n      bringForward(context.data.id, props)\n    }\n    if (context.type === 'connectioncreated') {\n      const { id } = context.data\n      const connection = props.editor.getConnection(id)\n\n      if (!connection) throw new Error('connection was removed')\n      bringConnectionBack(context.data.id, props)\n      bringForward(connection.source, props)\n      bringForward(connection.target, props)\n    }\n    return context\n  })\n}\n","import { NodeEditor } from 'rete'\nimport { BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { AgentParams } from './agents/types'\nimport { ExpectedScheme } from './types'\n\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, T> }\n\nexport function getNodesBoundingBox<T>(nodes: ExpectedScheme['Node'][], { area }: Props<T>) {\n  const boxes = nodes.map(node => {\n    const view = area.nodeViews.get(node.id)\n\n    if (!view) throw new Error('view')\n\n    return {\n      position: view.position,\n      width: node.width,\n      height: node.height\n    }\n  })\n\n  const left = Math.min(...boxes.map(b => b.position.x))\n  const right = Math.max(...boxes.map(b => b.position.x + b.width))\n  const top = Math.min(...boxes.map(b => b.position.y))\n  const bottom = Math.max(...boxes.map(b => b.position.y + b.height))\n  const width = right - left\n  const height = bottom - top\n\n  return {\n    top,\n    left,\n    right,\n    bottom,\n    width,\n    height\n  }\n}\n\ntype Size = { width: number, height: number }\n\nexport function updateNodeSizes<T>(node: ExpectedScheme['Node'], size: Size, { area }: Props<T>) {\n  const { width, height } = size\n\n  node.width = width\n  node.height = height\n\n  area.resize(node.id, width, height)\n}\n\n// eslint-disable-next-line max-statements\nexport async function resizeParent<T>(parent: ExpectedScheme['Node'], agentParams: AgentParams, props: Props<T>) {\n  const { id } = parent\n  const children = props.editor.getNodes()\n    .filter(child => child.parent === id)\n    .filter(node => !agentParams.exclude(node.id))\n  const padding = agentParams.padding(id)\n\n  if (children.length === 0) {\n    const size = agentParams.size(id, {\n      width: padding.left + padding.right,\n      height: padding.top + padding.bottom\n    })\n\n    updateNodeSizes(parent, size, props)\n  } else {\n    const { top, left, width, height } = getNodesBoundingBox(children, props)\n\n    const outerWidth = width + padding.left + padding.right\n    const outerHeight = height + padding.top + padding.bottom\n    const outerTop = top - padding.top\n    const outerLeft = left - padding.left\n\n    updateNodeSizes(parent, agentParams.size(id, { width: outerWidth, height: outerHeight }), props)\n    await agentParams.translate(parent.id, outerLeft, outerTop)\n  }\n  if (parent.parent) {\n    const parentsParent = props.editor.getNode(parent.parent)\n\n    if (parentsParent) {\n      await resizeParent(parentsParent, agentParams, props)\n    }\n  }\n}\n","import { NodeEditor, NodeId } from 'rete'\nimport { BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { AgentParams } from './agents/types'\nimport { resizeParent } from './sizing'\nimport { ExpectedScheme, Position } from './types'\n\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, T> }\n\n// eslint-disable-next-line max-statements, max-len\nexport async function reassignParent<T>(ids: NodeId[], pointer: { x: number, y: number }, agentParams: AgentParams, props: Props<T>) {\n  if (!ids.length) return\n  const nodes = ids\n    .map(id => props.editor.getNode(id))\n    .filter((n): n is ExpectedScheme['Node'] => Boolean(n))\n\n  const overlayNodes = props.editor.getNodes()\n    .map(node => {\n      const view = props.area.nodeViews.get(node.id)\n\n      if (!view) throw new Error('node view')\n\n      return { node, view }\n    }).filter(({ node, view }) => {\n      return !ids.includes(node.id)\n        && pointer.x > view.position.x\n        && pointer.y > view.position.y\n        && pointer.x < view.position.x + node.width\n        && pointer.y < view.position.y + node.height\n    })\n  const areaElements = Array.from(props.area.area.content.holder.childNodes)\n  const overlayNodesWithIndex = overlayNodes.map(({ node, view }) => {\n    const index = areaElements.indexOf(view.element)\n\n    return { node, view, index }\n  })\n\n  overlayNodesWithIndex.sort((a, b) => b.index - a.index)\n  const topOverlayParent = overlayNodesWithIndex[0]\n\n  const formerParents = nodes\n    .map(node => node.parent)\n    .filter((id): id is string => Boolean(id))\n    .map(id => {\n      const node = props.editor.getNode(id)\n\n      if (!node) throw new Error('node')\n\n      return node\n    })\n\n  // eslint-disable-next-line no-undefined\n  nodes.forEach(node => node.parent = undefined)\n  if (topOverlayParent) {\n    nodes.forEach(node => node.parent = topOverlayParent.node.id)\n    await resizeParent(topOverlayParent.node, agentParams, props)\n  }\n\n  for (const formerParent of formerParents) {\n    await resizeParent(formerParent, agentParams, props)\n  }\n}\n\nexport async function translateChildren<T>(id: NodeId, { position, previous }: { position: Position, previous: Position }, props: Props<T>) {\n  const children = props.editor.getNodes().filter(n => n.parent === id)\n\n  await Promise.all(children.map(async n => {\n    const dx = position.x - previous.x\n    const dy = position.y - previous.y\n\n    const view = props.area.nodeViews.get(n.id)\n    const node = props.editor.getNode(n.id)\n\n    if (view && node && !node.selected) {\n      const nodePosition = view.position\n\n      await view.translate(nodePosition.x + dx, nodePosition.y + dy)\n    }\n  }))\n}\n","import { BaseSchemes, NodeEditor, NodeId } from 'rete'\nimport { BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { ExpectedScheme } from './types'\n\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, T> }\n\nexport function belongsTo<T>(nodeId: NodeId, ids: NodeId[], props: Props<T>) {\n  const node = props.editor.getNode(nodeId)\n\n  if (!node) throw new Error('node')\n\n  if (ids.includes(nodeId)) return true\n  if (!node.parent) return false\n  if (belongsTo(node.parent, ids, props)) return true\n}\n\nexport function hasSelectedParent<T>(nodeId: NodeId, props: Props<T>): boolean {\n  const node = props.editor.getNode(nodeId)\n\n  if (!node) throw new Error('node')\n\n  if (!node.parent) return false\n\n  const parent = props.editor.getNode(node.parent)\n\n  if (!parent) throw new Error('node')\n\n  if (parent.selected) return true\n\n  return hasSelectedParent(node.parent, props)\n}\n\nexport type Translate = (nodeId: string, x: number, y: number) => Promise<void>\n\n/**\n * keep track of currently moving nodes (to prevent infinite loop)\n */\nexport function trackedTranslate<T>(props: Props<T>): {\n  translate: Translate,\n  isTranslating: (id: NodeId) => boolean\n} {\n  const active = new Map<NodeId, number>()\n  const increment = (id: NodeId) => active.set(id, (active.get(id) || 0) + 1)\n  const decrement = (id: NodeId) => active.set(id, (active.get(id) || 0) - 1)\n\n  return {\n    async translate(id, x, y) {\n      const view = props.area.nodeViews.get(id)\n\n      if (!view) throw new Error('cannot find parent node view')\n\n      const previous = view.position\n\n      if (previous.x !== x || previous.y !== y) {\n        increment(id)\n        await view.translate(x, y)\n        decrement(id)\n      }\n    },\n    isTranslating(id) {\n      return (active.get(id) || 0) > 0\n    }\n  }\n}\n\nexport function watchClearing(editor: NodeEditor<BaseSchemes>) {\n  let state = false\n\n  editor.addPipe(context => {\n    if (context.type === 'clear') {\n      state = true\n    }\n    if (context.type === 'cleared' || context.type === 'clearcancelled') {\n      state = false\n    }\n    return context\n  })\n\n  return () => state\n}\n","import { NodeEditor } from 'rete'\nimport { BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { ExpectedScheme } from './types'\nimport { watchClearing } from './utils'\n\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, T> }\n\nexport function useValidator<T>(props: Props<T>) {\n  const isClearing = watchClearing(props.editor)\n\n  // eslint-disable-next-line max-statements\n  props.area.addPipe(context => {\n    if (!context || !(typeof context === 'object' && 'type' in context)) return context\n    if (context.type === 'nodecreate') {\n      const parentId = context.data.parent\n\n      if (parentId) {\n        const parent = props.editor.getNodes().find(n => n.id === parentId)\n\n        if (!parent) throw new Error('parent node doesnt exist')\n      }\n    }\n    if (context.type === 'noderemove' && !isClearing()) {\n      const { id } = context.data\n\n      const child = props.editor.getNodes().find(n => n.parent === id)\n\n      if (child) throw new Error('cannot remove parent node with a children')\n    }\n    return context\n  })\n}\n","import { NodeId } from 'rete'\n\nimport { getPickedNodes } from '../..'\nimport { reassignParent } from '../../scope'\nimport { Position } from '../../types'\nimport { AgentContext, AgentParams, ScopeAgent } from '../types'\n\nexport type DefaultScopesAgentParams = AgentParams & {\n  timeout?: number\n}\n\nexport const useScopeAgent: ScopeAgent = (params: DefaultScopesAgentParams, { area, editor, scopes }) => {\n  const timeout = params.timeout || 250\n\n  let picked: { timeout: number } | null = null\n  let candidates: string[] = []\n\n  function cancel() {\n    if (picked) {\n      window.clearTimeout(picked.timeout)\n      picked = null\n    }\n  }\n\n  function pick(id: NodeId) {\n    const timeoutId = window.setTimeout(() => {\n      const selected = editor.getNodes().filter(n => n.selected)\n      const targets = selected.length ? selected.map(n => n.id) : [id]\n\n      candidates.push(...targets)\n      scopes.emit({ type: 'scopepicked', data: { ids: targets } })\n    }, timeout)\n\n    picked = { timeout: timeoutId }\n  }\n  function release() {\n    const list = [...candidates]\n\n    cancel()\n    candidates = []\n\n    scopes.emit({ type: 'scopereleased', data: { ids: list } })\n\n    return list\n  }\n\n  area.addPipe(async context => {\n    if (!('type' in context)) return context\n    if (context.type === 'nodepicked') {\n      pick(context.data.id)\n    }\n    if (context.type === 'nodetranslated') {\n      cancel()\n    }\n    if (context.type === 'nodedragged') {\n      const { pointer } = area.area\n      const ids = release()\n\n      await reassignParent(ids, pointer, params, { area, editor })\n    }\n    return context\n  })\n}\n\nexport function useVisualEffects<T>({ area, editor, scopes }: AgentContext<T>): void {\n  const pickedNodes = getPickedNodes(scopes)\n  let previousHighlighted: string | null = null\n  let clientPointerPostion: Position | null = null\n\n  // eslint-disable-next-line max-statements\n  function updateHighlightedScopes(position: { x: number, y: number }, nodes: NodeId[]) {\n    if (previousHighlighted) {\n      const view = area.nodeViews.get(previousHighlighted)\n\n      if (view && nodes.length) view.element.style.opacity = '0.4'\n      previousHighlighted = null\n    }\n    if (nodes.length) {\n      const { x, y } = position\n      const elements = document.elementsFromPoint(x, y)\n      const nodeViews = editor.getNodes().map(node => {\n        const view = area.nodeViews.get(node.id)\n\n        if (!view) throw new Error('view')\n\n        return {\n          node,\n          view\n        }\n      })\n\n      const intersectedNodes = elements\n        .map(el => nodeViews.find(item => item.view.element === el))\n        .filter((item): item is Exclude<typeof item, undefined> => Boolean(item))\n\n      const nonSelected = intersectedNodes\n        .filter(item => !item.node.selected)\n      const first = nonSelected[0]\n\n      if (first) {\n        first.view.element.style.opacity = '0.8'\n        previousHighlighted = first.node.id\n      }\n    }\n  }\n  // eslint-disable-next-line max-statements\n  scopes.addPipe(context => {\n    if (context.type === 'scopepicked') {\n      const { ids } = context.data\n\n      editor.getNodes().filter(n => !ids.includes(n.id)).forEach(node => {\n        const view = area.nodeViews.get(node.id)\n\n        if (view) view.element.style.opacity = '0.4'\n      })\n      if (clientPointerPostion) updateHighlightedScopes(clientPointerPostion, pickedNodes)\n    }\n    if (context.type === 'scopereleased') {\n      const { ids } = context.data\n\n      editor.getNodes().filter(n => !ids.includes(n.id)).forEach(node => {\n        const view = area.nodeViews.get(node.id)\n\n        if (view) view.element.style.opacity = ''\n      })\n      if (clientPointerPostion) updateHighlightedScopes(clientPointerPostion, pickedNodes)\n    }\n    if (context.type === 'pointermove') {\n      clientPointerPostion = {\n        x: context.data.event.clientX,\n        y: context.data.event.clientY\n      }\n      updateHighlightedScopes(clientPointerPostion, pickedNodes)\n    }\n    return context\n  })\n}\n","import { classic } from '../../agents'\nimport { Preset } from '../types'\n\n/**\n * Classic preset allowing capturing a node by long-pressing it and dropping it onto another node to make it a nested.\n * @returns Preset\n * @listens nodepicked\n * @listens nodetranslated\n * @listens nodedragged\n * @emits scopepicked\n * @emits scopereleased\n */\nexport function setup(): Preset {\n  return (params, context) => {\n    classic.useScopeAgent(params, context)\n    classic.useVisualEffects(context)\n  }\n}\n","/**\n * Presets for scopes plugin.\n * @module\n */\n\nexport * as classic from './classic'\n","import { NodeEditor, NodeId, Root, Scope } from 'rete'\nimport { BaseArea, BaseAreaPlugin } from 'rete-area-plugin'\n\nimport { useOrdering } from './ordering'\nimport { Preset } from './presets/types'\nimport { translateChildren } from './scope'\nimport { resizeParent } from './sizing'\nimport { ExpectedScheme, Padding, Size } from './types'\nimport { belongsTo, hasSelectedParent, trackedTranslate } from './utils'\nimport { useValidator } from './validation'\n\nexport * as Presets from './presets'\n\n/**\n * Props for `ScopesPlugin` class.\n */\nexport type Props = {\n  /** Padding (space) between the scope's border and its children. Default is `() => ({ top: 40, left: 20, right: 20, bottom: 20 })` */\n  padding?: (id: NodeId) => Padding\n  /** Determines whether the nested node should be excluded from affecting the scope's size, etc. Default is `() => false` */\n  exclude?: (id: NodeId) => boolean\n  /** Customizes the size of the node which is recognized as a parent. Default is `(id, size) => size` */\n  size?: (id: NodeId, size: Size) => Size\n}\n\ntype Requires<Schemes extends ExpectedScheme> =\n  | BaseArea<Schemes>\n\n/**\n * Signal types produced by ConnectionPlugin instance\n * @priority 10\n */\nexport type Scopes =\n  | { type: 'scopepicked', data: { ids: NodeId[] } }\n  | { type: 'scopereleased', data: { ids: NodeId[] } }\n  | { type: 'scopeupdated', data: { id: NodeId } }\n\n/**\n * Scope plugin. Responsible for user interaction with scopes (nested nodes, groups)\n * @priority 9\n * @listens nodetranslated\n * @listens noderemoved\n * @emits scopepicked\n * @emits scopereleased\n */\nexport class ScopesPlugin<Schemes extends ExpectedScheme, T = never> extends Scope<Scopes, [Requires<Schemes>, Root<Schemes>]> {\n  padding: (id: NodeId) => Padding\n  exclude: (id: NodeId) => boolean\n  size: (id: NodeId, size: Size) => Size\n  editor!: NodeEditor<Schemes>\n  area!: BaseAreaPlugin<Schemes, T>\n  presets: Preset[] = []\n\n  constructor(props?: Props) {\n    super('scopes')\n    this.padding = props?.padding || (() => ({\n      top: 40,\n      left: 20,\n      right: 20,\n      bottom: 20\n    }))\n    this.exclude = props?.exclude || (() => false)\n    this.size = props?.size || ((id, size) => size)\n  }\n\n  // eslint-disable-next-line max-statements\n  setParent(scope: Scope<BaseArea<Schemes>, [Root<Schemes>]>): void {\n    super.setParent(scope)\n\n    this.area = this.parentScope<BaseAreaPlugin<Schemes, T>>(BaseAreaPlugin)\n    this.editor = this.area.parentScope<NodeEditor<Schemes>>(NodeEditor)\n\n    const props = { editor: this.editor, area: this.area }\n    const { padding, size, exclude } = this\n    const pickedNodes = getPickedNodes(this)\n    const { translate, isTranslating } = trackedTranslate(props)\n    const agentParams = { padding, size, exclude, translate }\n\n    useValidator(props)\n    useOrdering(props)\n\n    this.presets.forEach(preset => {\n      preset(agentParams, { ...props, scopes: this })\n    })\n\n    // eslint-disable-next-line max-statements, complexity\n    this.addPipe(async context => {\n      if (context.type === 'nodetranslated') {\n        const { id } = context.data\n        const current = props.editor.getNode(id)\n\n        if (!current) throw new Error('cannot find node')\n        // prevent translating children if the node translation\n        // is triggered by its resizing (when its children moved)\n        if (!isTranslating(id)) {\n          await translateChildren(id, context.data, props)\n        }\n\n        const parent = current.parent ? props.editor.getNode(current.parent) : null\n\n        if (parent && !agentParams.exclude(id)) {\n          const hasAnySelectedParent = hasSelectedParent(id, props)\n          const isPicked = belongsTo(current.id, pickedNodes, props)\n\n          if (!hasAnySelectedParent && !isPicked) {\n            await resizeParent(parent, agentParams, props)\n          }\n        }\n      }\n      if (context.type === 'noderemoved') {\n        const parentId = context.data.parent\n        const parent = parentId && props.editor.getNode(parentId)\n\n        if (parent) {\n          await resizeParent(parent, agentParams, props)\n        }\n      }\n      if (context.type === 'scopeupdated') {\n        const parent = this.editor.getNode(context.data.id)\n\n        if (parent) {\n          await resizeParent(parent, agentParams, props)\n        }\n      }\n      return context\n    })\n  }\n\n  /**\n   * Adds a preset to the plugin.\n   * @param preset Preset that is responsible for user interactions with scopes (e.g. assigning nodes to scopes)\n   */\n  public addPreset(preset: Preset) {\n    this.presets.push(preset)\n  }\n\n  public isDependent(id: NodeId) {\n    const props = { editor: this.editor, area: this.area }\n    const node = this.editor.getNode(id)\n\n    return node && (node.selected || hasSelectedParent(id, props))\n  }\n\n  public async update(scopeId: NodeId) {\n    await this.emit({ type: 'scopeupdated', data: { id: scopeId } })\n  }\n}\n\nexport function getPickedNodes<S extends ExpectedScheme>(scopes: Scope<Scopes, [Requires<S>, Root<S>]>) {\n  const nodes: NodeId[] = []\n\n  scopes.addPipe(async context => {\n    if (!('type' in context)) return context\n    if (context.type === 'scopepicked') {\n      nodes.push(...context.data.ids)\n    }\n    if (context.type === 'scopereleased') {\n      nodes.splice(0, nodes.length, ...nodes.filter(id => !context.data.ids.includes(id)))\n    }\n    return context\n  })\n  return nodes\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}